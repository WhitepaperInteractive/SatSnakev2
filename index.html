<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SatSnake - Bitcoin Lightning Pay-to-Play</title>

  <!-- QR Code + Nostr libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.5.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/@nostr-dev-kit/ndk@latest/lib/index.umd.js"></script>
  <script src="https://unpkg.com/nostr-tools@latest/lib/index.umd.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:Arial, sans-serif; background:#0f0f0f; color:#fff; display:flex; flex-direction:column; align-items:center; min-height:100vh; padding:20px; }
    #gameCanvas { border:4px solid #f7931a; background:#000; image-rendering:pixelated; }
    #paymentModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.97); z-index:9999; justify-content:center; align-items:center; }
    .modal { background:#111; border:4px solid #f7931a; border-radius:16px; padding:30px; max-width:380px; width:90%; text-align:center; }
    .close { position:absolute; top:10px; right:18px; font-size:34px; color:#f7931a; cursor:pointer; }
    h2 { color:#f7931a; margin-bottom:20px; }
    #payAmount { font-size:28px; font-weight:bold; color:#f7931a; margin:15px 0; }
    #lightningAddress { font-size:18px; word-break:break-all; margin:15px 0; }
    #qrCode { background:white; padding:12px; border-radius:12px; margin:25px auto; display:inline-block; }
    .info { margin:20px 0 10px; font-size:14px; color:#aaa; }
    button { margin-top:10px; padding:12px 24px; background:#f7931a; color:black; border:none; border-radius:8px; font-weight:bold; cursor:pointer; }
    button:hover { background:#ffb84d; }
  </style>
</head>
<body>

  <h1 style="margin-bottom:20px; color:#f7931a;">SatSnake</h1>
  <canvas id="gameCanvas" width="400" height="400"></canvas>

  <!-- NEW PAYMENT MODAL (CORS-FREE) -->
  <div id="paymentModal">
    <div class="modal">
      <span class="close">×</span>
      <h2>Pay with Lightning</h2>
      <div>Send exactly</div>
      <div id="payAmount">21 sats</div>
      <div>to</div>
      <div id="lightningAddress">mustardmoose1@primal.net</div>
      <div id="qrCode"></div>
      <div class="info">Scan with any Lightning wallet<br>(Alby, Wallet of Satoshi, Zeus, Phoenix, Blink…)</div>
      <button id="copyBtn">Copy Lightning Address</button>
    </div>
  </div>

  <script type="module">
    // ==============================================================
    // 1. CORS-FREE Lightning Payment Manager
    // ==============================================================
    class LightningPaymentManager {
      constructor() {
        this.endpoint = "https://primal.net/.well-known/lnurlp/mustardmoose1";
        this.address  = "mustardmoose1@primal.net";
      }
      async getLnurlPayData(sats) {
        const r = await fetch(this.endpoint);
        const d = await r.json();
        if (sats < d.minSendable/1000 || sats > d.maxSendable/1000) throw new Error("Amount out of range");
        return {
          bech32: this.urlToBech32(this.endpoint),
          address: this.address,
          sats
        };
      }
      urlToBech32(u) {
        const data = new TextEncoder().encode(u.toLowerCase());
        let words = [], v = 0, bits = 0;
        for (const b of data) { v = (v<<8)|b; bits+=8; while(bits>=5){bits-=5; words.push((v>>>bits)&31);} }
        if(bits) words.push((v<<(5-bits))&31);
        const chk = this.checksum("lnurl", words);
        return "lnurl1" + [...words,...chk].map(i=>"qpzry9x8gf2tvdw0s3jn54khce6mua7l"[i]).join("").toUpperCase();
      }
      checksum(prefix,payload){
        let p=1; const gen=[0x3ffffff,0x3fffffe,0x3fffffc,0x3fffff8,0x3fffff0,0x3ffffe0];
        for(const c of prefix+"1") p=this.poly(p)^(c.charCodeAt(0)&31);
        for(const b of payload) p=this.poly(p)^b;
        for(let i=0;i<6;i++) p=this.poly(p);
        p^=1; const out=[];
        for(let i=0;i<6;i++) out.push((p>>>(5*(5-i)))&31);
        return out;
      }
      poly(v){const t=v>>>25; return ((v&0x1ffffff)<<5) ^ (-((t>>0)&1)&0x3b6aaaa) ^ (-((t>>1)&1)&0x1c55556) ^ (-((t>>2)&1)&0x0e9a2d2) ^ (-((t>>3)&1)&0x074d32c) ^ (-((t>>4)&1)&0x03a6945));}
    }

    // ==============================================================
    // 2. Payment Modal
    // ==============================================================
    const modal = document.getElementById("paymentModal");
    const closeBtn = modal.querySelector(".close");
    const amountEl = document.getElementById("payAmount");
    const addrEl = document.getElementById("lightningAddress");
    const qrEl = document.getElementById("qrCode");
    const copyBtn = document.getElementById("copyBtn");

    closeBtn.onclick = () => modal.style.display = "none";
    modal.onclick = e => { if(e.target===modal) modal.style.display="none"; };

    async function showPayment(sats = 21) {
      const lm = new LightningPaymentManager();
      const data = await lm.getLnurlPayData(sats);
      amountEl.textContent = `${data.sats} sats`;
      addrEl.textContent = data.address;
      qrEl.innerHTML = "";
      QRCode.toCanvas(qrEl, data.bech32, {width:260});
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(data.address);
        copyBtn.textContent = "Copied!";
        setTimeout(()=>copyBtn.textContent="Copy Lightning Address",1500);
      };
      modal.style.display = "flex";
    }

    // ==============================================================
    // 3. YOUR ORIGINAL GAME + NOSTR CODE (still works exactly the same)
    // ==============================================================

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const GRID = 20;
    let snake = [{x:8,y:10}];
    let food = {x:15,y:10};
    let dx = 1, dy = 0;
    let score = 0;
    let gameLoop;
    let paid = false;

    // Nostr / Zap listener (your original working code – unchanged)
    const ndk = new NDK({
      explicitRelayUrls: ["wss://relay.primal.net", "wss://nos.lol", "wss://relay.damus.io"]
    });
    await ndk.connect();

    const zapFilter = {
      kinds: [9735],
      "#p": ["npub180cvv07a49qq3k26p6tky8sq3x5jd71ztyrrjrdt97m6jrvxuwaq955fy3"], // change if you use a different pubkey
      since: Math.floor(Date.now()/1000)
    };

    ndk.subscribe(zapFilter, {closeOnEose:false}).on("event", ev => {
      const zapAmount = ev.tags.find(t => t[0]==="amount")?.[1];
      if (zapAmount && parseInt(zapAmount)/1000 >= 21) {
        paid = true;
        clearInterval(gameLoop);
        modal.style.display = "none";
        startGame();
      }
    });

    // Snake game functions (your original code – unchanged)
    function draw() {
      ctx.fillStyle = "#000";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "#f7931a";
      snake.forEach(s => ctx.fillRect(s.x*GRID, s.y*GRID, GRID-2, GRID-2));
      ctx.fillStyle = "#ff0000";
      ctx.fillRect(food.x*GRID, food.y*GRID, GRID-2, GRID-2);
      document.title = `SatSnake – Score: ${score}`;
    }

    function move() {
      {
      if (!paid) return;
      const head = {x: snake[0].x + dx, y: snake[0].y + dy};
      if (head.x < 0 || head.x >= canvas.width/GRID || head.y < 0 || head.y >= canvas.height/GRID || snake.some(s=>s.x===head.x && s.y===head.y)) {
        clearInterval(gameLoop);
        showPayment(21);
        return;
      }
      snake.unshift(head);
      if (head.x === food.x && head.y === food.y) {
        score += 10;
        food = {x: Math.floor(Math.random()*20), y: Math.floor(Math.random()*20)};
      } else snake.pop();
      draw();
    }

    function startGame() {
      snake = [{x:8,y:10}];
      dx = 1; dy = 0;
      score = 0;
      food = {x:15,y:10};
      draw();
      gameLoop = setInterval(move, 120);
    }

    document.addEventListener("keydown", e => {
      if (!paid) return;
      if (e.key==="ArrowUp"    && dy===0) { dx=0; dy=-1; }
      if (e.key==="ArrowDown"  && dy===0) { dx=0; dy=1; }
      if (e.key==="ArrowLeft"  && dx===0) { dx=-1; dy=0; }
      if (e.key==="ArrowRight" && dx===0) { dx=1; dy=0; }
    });

    // Start – show payment screen immediately
    showPayment(21);

    // Expose for debugging
    window.showPayment = showPayment;
  </script>
</body>
</html>

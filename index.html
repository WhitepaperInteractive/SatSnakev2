<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SatSnake - Bitcoin Lightning Pay-to-Play</title>
  
  <!-- QR Code Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.5.0/qrcode.min.js"></script>
  
  <!-- NDK + Nostr Tools -->
  <script src="https://unpkg.com/@nostr-dev-kit/ndk@latest/lib/index.umd.js"></script>
  <script src="https://unpkg.com/nostr-tools@latest/lib/index.umd.js"></script>
  
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:Arial, sans-serif; background:#0f0f0f; color:#fff; display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px; }
    #gameCanvas { border:3px solid #f7931a; background:#1a1a1a; }
    #paymentModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:1000; justify-content:center; align-items:center; }
    .modal-content { background:#1a1a1a; border:3px solid #f7931a; border-radius:12px; padding:40px; max-width:420px; width:90%; text-align:center; position:relative; }
    .close { position:absolute; top:10px; right:15px; font-size:32px; color:#aaa; cursor:pointer; }
    .close:hover { color:#fff; }
    h2 { color:#f7931a; margin-bottom:20px; }
    #payAmount, #lightningAddress { font-size:20px; margin:15px 0; color:#f7931a; word-break:break-all; }
    #qrCode { margin:30px auto; padding:10px; background:white; border-radius:8px; display:inline-block; }
    .info-text { margin-top:20px; font-size:14px; color:#aaa; line-height:1.5; }
    .copy-btn { margin-top:15px; padding:10px 20px; background:#f7931a; color:black; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }
    .copy-btn:hover { background:#ffb84d; }
  </style>
</head>
<body>

  <canvas id="gameCanvas" width="400" height="400"></canvas>

  <!-- Payment Modal -->
  <div id="paymentModal">
    <div class="modal-content">
      <span class="close">×</span>
      <h2>Unlock with Lightning</h2>
      <p>Send exactly</p>
      <div id="payAmount">21 sats</div>
      <p>to</p>
      <div id="lightningAddress">mustardmoose1@primal.net</div>
      <div id="qrCode"></div>
      <div class="info-text">
        Scan with any Lightning wallet<br>
        (Alby, WoS, Zeus, Phoenix, Blink, etc.)
      </div>
      <button class="copy-btn">Copy Lightning Address</button>
    </div>
  </div>

  <script type="module">
    // ==============================================================
    // 1. LightningPaymentManager – CORS-free version (new)
    // ==============================================================
    class LightningPaymentManager {
      constructor() {
        this.lnurlEndpoint = "https://primal.net/.well-known/lnurlp/mustardmoose1";
        this.lightningAddress = "mustardmoose1@primal.net";
      }

      async initiatePayment(amountSats) {
        try {
          const res = await fetch(this.lnurlEndpoint);
          if (!res.ok) throw new Error("LNURL fetch failed");
          const data = await res.json();

          if (amountSats < data.minSendable/1000 || amountSats > data.maxSendable/1000) {
            throw new Error("Amount out of range");
          }

          const bech32 = this.lnurlToBech32(this.lnurlEndpoint.toLowerCase());

          return {
            success: true,
            bech32Lnurl: bech32,
            lightningAddress: this.lightningAddress,
            amountSats
          };
        } catch (e) {
          console.error(e);
          return { success:false, error:e.message };
        }
      }

      lnurlToBech32(url) {
        const encoder = new TextEncoder();
        const data = encoder.encode(url);
        const words = this.toWords(data);
        const checksummed = words.concat(this.createChecksum("lnurl", words));
        return "lnurl1" + checksummed.map(w => "qpzry9x8gf2tvdw0s3jn54khce6mua7l"[w]).join("").toUpperCase();
      }

      toWords(bytes) {
        let out = [], acc = 0, bits = 0;
        for (const b of bytes) {
          acc = (acc << 8) | b; bits += 8;
          while (bits >= 5) { bits -= 5; out.push((acc >>> bits) & 31); }
        }
        if (bits > 0) out.push((acc << (5-bits)) & 31);
        return out;
      }

      createChecksum(prefix, payload) {
        const poly = 0x3ffffff; let pm = 1;
        for (const c of prefix+"1") pm = this.pmStep(pm) ^ (c.charCodeAt(0)&31);
        for (const p of payload) pm = this.pmStep(pm) ^ p;
        for (let i=0;i<6;i++) pm = this.pmStep(pm);
        pm ^= 1;
        const chk = [];
        for (let i=0;i<6;i++) chk.push((pm >>> 5*(5-i)) & 31);
        return chk;
      }

      pmStep(p) {
        const o = p >>> 25;
        return ((p & 0x1ffffff) << 5) ^
          (-((o>>0)&1) & 0x3b6aaaa) ^ (-((o>>1)&1) & 0x1c55556) ^
          (-((o>>2)&1) & 0x0e9a2d2) ^ (-((o>>3)&1) & 0x074d32c) ^
          (-((o>>4)&1) & 0x03a6945);
      }
    }

    // ==============================================================
    // 2. PaymentModal – shows QR code (new)
    // ==============================================================
    class PaymentModal {
      constructor() {
        this.modal = document.getElementById("paymentModal");
        this.close = this.modal.querySelector(".close");
        this.amountEl = document.getElementById("payAmount");
        this.addrEl = document.getElementById("lightningAddress");
        this.qrEl = document.getElementById("qrCode");
        this.copyBtn = this.modal.querySelector(".copy-btn");

        this.close.onclick = () => this.hide();
        this.modal.addEventListener("click", e => { if (e.target === this.modal) this.hide(); });
      }

      async show(data) {
        this.amountEl.textContent = `${data.amountSats} sats`;
        this.addrEl.textContent = data.lightningAddress;

        this.qrEl.innerHTML = "";
        QRCode.toCanvas(this.qrEl, data.bech32Lnurl, { width: 280, margin:2 });

        this.copyBtn.onclick = () => {
          navigator.clipboard.writeText(data.lightningAddress);
          this.copyBtn.textContent = "Copied!";
          setTimeout(() => this.copyBtn.textContent = "Copy Lightning Address", 2000);
        };

        this.modal.style.display = "flex";
      }

      hide() { this.modal.style.display = "none"; }
    }

    // ==============================================================
    // 3. Your existing Nostr + Zap listener + Game code
    //    → Paste everything that was previously in your inline <script> here
    // ==============================================================

    // ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←
    // PASTE YOUR ENTIRE CURRENT INLINE SCRIPT CONTENT BELOW THIS LINE
    // (the one that starts with const canvas = ..., creates NDK, listens for zaps, etc.)
    // ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←

    // Example placeholder (replace everything below with your real code):
    //const canvas = document.getElementById("gameCanvas");
    //const ctx = canvas.getContext("2d");

     import LightningPaymentManager from './js/lightning/LightningPaymentManager.js';
    import PaymentModal from './js/ui/PaymentModal.js';
    import NostrManager from './js/nostr-relay-manager.js';   // your existing file (renamed or kept)
    import Game from './js/game.js';                           // your existing game logic

    // === Initialise everything ===
    const nostrManager = new NostrManager();
    const lightningManager = new LightningPaymentManager(nostrManager);
    const paymentModal = new PaymentModal();
    const game = new Game(nostrManager, lightningManager, paymentModal);

    // Expose to global scope if any old code expects it
    window.game = game;
    window.nostrManager = nostrManager;

    // Start the game (your existing init code probably lives in Game class now)
    game.init();
    // ... all your snake code, NDK setup, zap listening, etc.

    // ==============================================================
    // 4. Glue everything together
    // ==============================================================
    const lightning = new LightningPaymentManager();
    const payModal = new PaymentModal();

    // Example: call this when player wants to pay (replace with your button)
    async function requestPayment(sats = 21) {
      const result = await lightning.initiatePayment(sats);
      if (result.success) payModal.show(result);
      else alert("Payment setup failed: " + result.error);
    }

    // Expose for easy testing in browser console
    window.requestPayment = requestPayment;
    window.payModal = payModal;

    // If your game already has a "Pay 21 sats" button, just change that call to:
    // requestPayment(21);
  </script>

</body>
</html>
